# Azure Deployment Plan for spring-petclinic Project

## **Goal**
Deploy the Spring PetClinic application to Azure Container Apps using Azure Developer CLI (azd) with Bicep infrastructure as code.

## **Project Information**

**Spring PetClinic**  
- **Stack**: Spring Boot 4.0.1 (Java 17)  
- **Type**: Web application for managing veterinary clinic records with Thymeleaf templates  
- **Database**: H2 (in-memory), with MySQL/PostgreSQL support  
- **Containerization**: No Dockerfile present - needs to be created  
- **Dependencies**: H2 database (default), optional MySQL/PostgreSQL  
- **Hosting**: Azure Container Apps

## **Azure Resources Architecture**

> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazurecontainerapps_petclinic["`Name: petclinic
Path: /home/runner/work/spring-petclinic/spring-petclinic
Language: java`"]

subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps (ACA) Environment"]
azurecontainerapps_petclinic("`petclinic (Azure Container App)`")
end
containerappenv:::cluster
end

subgraph "Supporting Services"
acr("`Azure Container Registry`")
appinsights("`Application Insights`")
loganalytics("`Log Analytics Workspace`")
identity("`User-Assigned Managed Identity`")
end

%% Relationships
svcazurecontainerapps_petclinic --> |"hosted on"| azurecontainerapps_petclinic
azurecontainerapps_petclinic --> |"pulls image from"| acr
azurecontainerapps_petclinic --> |"logs to"| appinsights
azurecontainerapps_petclinic --> |"uses"| identity
appinsights --> |"stores in"| loganalytics
identity --> |"AcrPull access"| acr
```

**Resource Relationships:**
- The container app pulls its Docker image from the Azure Container Registry
- The container app uses a User-Assigned Managed Identity for secure authentication
- Application metrics and logs are sent to Application Insights
- All logs are stored in Log Analytics Workspace for analysis
- The managed identity has AcrPull role on the Container Registry for image pulling

## **Recommended Azure Resources**

**Application: petclinic**
- **Hosting Service Type**: Azure Container Apps
- **SKU**: Consumption (0.5 vCPU, 1.0 GiB memory per replica)
  - Automatic scaling from 0 to 10 replicas
  - Pay-per-use pricing model
  - Suitable for web applications with variable load
- **Configuration**:
    - Language: Java 17
    - Port: 8080
    - Environment Variables: 
      - `SPRING_PROFILES_ACTIVE`: default (uses H2 in-memory database)
      - `SERVER_PORT`: 8080
    - dockerFilePath: /home/runner/work/spring-petclinic/spring-petclinic/Dockerfile
    - dockerContext: /home/runner/work/spring-petclinic/spring-petclinic
- **Dependencies Resource**: None (uses embedded H2 database)

## **Recommended Supporting Services**

- **Azure Container Registry**: Basic SKU for storing Docker images
- **Application Insights**: For application monitoring and telemetry
- **Log Analytics Workspace**: Centralized logging and analytics for all services
- **User-Assigned Managed Identity**: Secure authentication between Azure services

## **Recommended Security Configurations**

- User-Assigned Managed Identity must be assigned to the Container App
- User-Assigned Managed Identity must have **AcrPull** role (7f951dda-4ed3-4680-a7ca-43fe172d538d) assigned to the Container Registry
- Container App environment configured with the managed identity
- All secrets and connection strings stored securely using Container Apps secrets

## **Execution Steps**

> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan.**

### Execution Checklist:

1. **Containerization**:
    - [ ] Analyze repository structure using `appmod-analyze-repository`
    - [ ] Generate Dockerfile using `appmod-plan-generate-dockerfile` tool
    - [ ] Create Dockerfile for Java 17 Spring Boot application
    - [ ] Verify Dockerfile builds successfully
    - **Output**: Dockerfile in project root

2. **Create Azure Infrastructure Files for AZD**:
    - [ ] Verify provisioning tool: AZD
    - [ ] Get current subscription ID from Azure CLI
    - [ ] Call `appmod-get-available-region-sku` to get available regions and SKUs for:
      - Microsoft.App/containerApps
      - Microsoft.ContainerRegistry/registries
      - Microsoft.OperationalInsights/workspaces
      - Microsoft.Insights/components
      - Microsoft.ManagedIdentity/userAssignedIdentities
    - [ ] Call `appmod-get-iac-rules` with deploymentTool=azd and iacType=bicep
    - [ ] Generate azure.yaml file with service configuration
    - [ ] Generate infra/main.bicep with all Azure resources
    - [ ] Generate infra/main.parameters.json with parameter values
    - [ ] Validate Bicep files for syntax errors
    - **Output**: azure.yaml, infra/main.bicep, infra/main.parameters.json

3. **Environment Setup for AZD**:
    - [ ] Install Azure CLI (if not installed)
    - [ ] Install Azure Developer CLI (if not installed)
    - [ ] Create new azd environment: `azd env new <envName> --no-prompt`
    - [ ] Set Azure subscription ID: use default from AZ CLI
    - [ ] Set AZURE_RESOURCE_GROUP environment variable
    - [ ] Create resource group using AZ CLI (if Bicep uses resource group scope)
    - [ ] Configure any additional environment variables from infra files

4. **Deployment**:
    - [ ] Run `azd provision --preview --no-prompt` to preview infrastructure
    - [ ] Review preview output for correctness
    - [ ] Run `azd up --no-prompt` to provision infrastructure and deploy application
    - [ ] Monitor deployment progress
    - [ ] If errors occur, fix issues and retry
    - [ ] Verify all resources are created in Azure Portal

5. **Deployment Validation**:
    - [ ] Check application logs using `appmod-get-azd-app-logs` tool
    - [ ] Verify application is running and accessible
    - [ ] Test application endpoints
    - [ ] Verify Application Insights is receiving telemetry

6. **Summarize Deployment Result**:
    - [ ] Use `appmod-summarize-result` tool to generate deployment summary
    - [ ] Document all created resources
    - [ ] Document application URLs and access information
    - **Output**: .azure/summary.copilotmd

## **Progress Tracking**

Progress will be tracked in `.azure/progress.copilotmd` after each step with:
- ‚úÖ Completed tasks
- üî≤ Pending tasks  
- ‚ùå Failed tasks with error notes

If a step fails, the error will be logged, the issue will be fixed, and the step will be retried until completion.
