# Azure Deployment Plan for spring-petclinic Project

## **Goal**
Deploy the Spring PetClinic application to Azure using Azure Developer CLI (AZD) with Azure Container Apps as the hosting platform.

## **Project Information**

**Spring PetClinic**  
- **Stack**: Java 17, Spring Boot 4.0.1, Maven
- **Type**: Web application for managing pet clinic operations with Thymeleaf templates
- **Containerization**: No Dockerfile present (needs to be created)
- **Dependencies**: In-memory H2 database (default), supports MySQL and PostgreSQL
- **Hosting**: Azure Container Apps

## **Azure Resources Architecture**

> **Install the mermaid extension in IDE to view the architecture.**

```mermaid
graph TD
%% Services
svcazurecontainerapps_web["`Name: web
Path: src/main/java/org/springframework/samples/petclinic
Language: java`"]
subgraph "Compute Resources"
%% Resources
subgraph containerappenv["Azure Container Apps (ACA) Environment"]
azurecontainerapps_web("`web (Azure Container App)`")
end
containerappenv:::cluster
end
subgraph "Supporting Services"
acr("`Azure Container Registry`")
insights("`Application Insights`")
logs("`Log Analytics Workspace`")
identity("`User-Assigned Managed Identity`")
end
%% Relationships
svcazurecontainerapps_web --> |"hosted on"| azurecontainerapps_web
azurecontainerapps_web --> |"pulls image from"| acr
azurecontainerapps_web --> |"logs to"| insights
azurecontainerapps_web --> |"uses"| identity
insights --> |"stores data in"| logs
identity --> |"has AcrPull role for"| acr
```

**Architecture Relations:**
- The container app gets its image from the Azure Container Registry
- The container app uses User-Assigned Managed Identity for secure access
- Application Insights monitors the application and stores telemetry in Log Analytics Workspace
- The managed identity has AcrPull role assignment to pull images from ACR

## **Recommended Azure Resources**

### Application: spring-petclinic (web service)
- **Hosting Service Type**: Azure Container Apps
- **SKU**: Consumption (0.5 vCPU, 1.0 GB memory) - Auto-scales based on HTTP traffic
- **Configuration**:
  - Language: Java
  - Java Version: 17
  - Port: 8080
  - Environment Variables:
    - `SPRING_PROFILES_ACTIVE`: "default" (uses H2 in-memory database)
    - `SERVER_PORT`: "8080"
  - dockerFilePath: ./Dockerfile
  - dockerContext: .
- **Dependencies**: None (uses embedded H2 database by default)

## **Recommended Supporting Services**

- **Azure Container Registry**: 
  - SKU: Basic (suitable for development/test workloads)
  - Purpose: Store and manage container images
  
- **Application Insights**: 
  - Purpose: Application performance monitoring and telemetry
  - Connected to Log Analytics Workspace
  
- **Log Analytics Workspace**: 
  - Purpose: Centralized logging for all Azure resources
  - Retention: 30 days (default)
  
- **User-Assigned Managed Identity**: 
  - Purpose: Secure authentication between Azure services
  - Required permissions: AcrPull role on Container Registry

## **Recommended Security Configurations**

- User-Assigned Managed Identity must have permissions into Azure Container Registry
- User-Assigned Managed Identity must be assigned to the Container App
- **AcrPull role assignment**: User managed identity must have **AcrPull** role ("7f951dda-4ed3-4680-a7ca-43fe172d538d") assigned to the container registry
- Container Apps Environment uses managed identity for secure communication

## **Execution Steps**

> **Below are the steps for Copilot to follow; ask Copilot to update or execute this plan. Add check list for the steps.**

### Execution Steps:

1. **Containerization**:
   - Check if Dockerfile exists in the repository
   - If missing, create a Dockerfile for the Spring Boot application
   - Ensure the Dockerfile:
     - Uses appropriate Java base image (Java 17)
     - Builds the application using Maven
     - Exposes port 8080
     - Sets the proper entrypoint for Spring Boot JAR
   - Output: Dockerfile at repository root

2. **Create Azure Infrastructure Files for AZD**:
   1. Provisioning tool: AZD. Expected files: azure.yaml, infra/main.bicep, infra/main.parameters.json
   2. Grab current subscriptionID (a4ab3025-1b32-4394-92e0-d07c1ebf3787), call tool `appmod-get-available-region-sku` to get available region and SKUs for Azure Container Apps (Microsoft.App/containerApps) and Azure Container Registry (Microsoft.ContainerRegistry/registries)
   3. Since expected files do not exist:
      - Call tool `appmod-get-iac-rules` with deploymentTool="azd", iacType="bicep", resourceTypes=["containerapp", "azurecontainerregistry"]
      - Generate azure.yaml with service configuration
      - Generate infra/main.bicep with:
        - Container Apps Environment
        - Container App with Java configuration
        - Container Registry
        - Application Insights
        - Log Analytics Workspace
        - User-Assigned Managed Identity
        - Role assignments (AcrPull)
      - Generate infra/main.parameters.json with required parameters
      - Generating Files: azure.yaml, infra/main.bicep, infra/main.parameters.json

3. **Env setup for azd**:
   1. Install AZ CLI and AZD if not installed
   2. Run 'azd env new spring-petclinic-env --no-prompt' to create a new environment
   3. Review infra/main.bicep and infra/main.parameters.json for environment variables
   4. Set the subscription: `azd env set AZURE_SUBSCRIPTION_ID a4ab3025-1b32-4394-92e0-d07c1ebf3787`
   5. Set AZURE_LOCATION environment variable to an available region for Container Apps
   6. Create a resource group if needed for deployment

4. **Create GitHub Actions CI/CD Pipeline**:
   1. Call tool `appmod-get-cicd-pipeline-guidance` to get guidance for creating GitHub Actions workflow
   2. Create .github/workflows/azure-deploy.yml with:
      - Build job: Build Java application with Maven, build Docker image
      - Deploy job: Provision Azure resources and deploy to Container Apps
      - Use GitHub OIDC for Azure authentication
      - Configure environment variables and secrets
   3. Set up required GitHub secrets:
      - AZURE_CLIENT_ID
      - AZURE_TENANT_ID
      - AZURE_SUBSCRIPTION_ID

5. **Local Deployment Validation**:
   1. Run `azd provision --preview --no-prompt` to dry run infrastructure
   2. Run `azd up --no-prompt` to provision and deploy
   3. If errors occur, iterate and fix infrastructure files
   4. Verify deployment by accessing the Container App URL

6. **Summarize Deployment Result**:
   1. Document the deployed resources and their URLs
   2. Create .azure/summary.copilotmd with deployment summary
   3. Include application URL, monitoring links, and next steps

## **Progress Tracking**

Progress will be tracked in `.azure/progress.copilotmd` after each step:

- Example format:
  - ‚úÖ [x] Containerization complete (Dockerfile created at ./Dockerfile)
  - üî≤ [ ] Infrastructure files generation in progress
  - ‚ùå Failed tasks with error notes and retry attempts
