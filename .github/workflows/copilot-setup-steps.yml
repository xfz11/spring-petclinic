name: Copilot Setup Steps

on:
  workflow_dispatch:

jobs:
  setup-azure:
    runs-on: ubuntu-latest
    environment: dev
    permissions:
      contents: read
      id-token: write
    
    steps:
      - name: Check out the repository
        uses: actions/checkout@v4
      
      - name: Install Azure CLI
        run: |
          curl -sL https://aka.ms/InstallAzureCLIDeb | sudo bash
      
      - name: Verify Azure CLI installation
        run: |
          az --version
      
      - name: Azure login
        uses: azure/login@v2
        with:
          client-id: d8e173e1-90f5-43f7-a34b-494c1c56f9ec
          tenant-id: 72f988bf-86f1-41af-91ab-2d7cd011db47
          subscription-id: a4ab3025-1b32-4394-92e0-d07c1ebf3787
      
      - name: Verify Azure Login
        run: |
          az account set --subscription a4ab3025-1b32-4394-92e0-d07c1ebf3787
          az account show
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Get PostgreSQL Region and SKU Recommendations
        run: |
          echo "=========================================="
          echo "Getting PostgreSQL recommendations..."
          echo "=========================================="
          python infra/get_postgres_recommendations.py
        env:
          AZURE_SUBSCRIPTION_ID: a4ab3025-1b32-4394-92e0-d07c1ebf3787
      
      - name: Display Deployment Instructions
        run: |
          echo "=========================================="
          echo "Next Steps for PostgreSQL Deployment"
          echo "=========================================="
          echo ""
          echo "The appmod-get-available-region-sku tool has been demonstrated above."
          echo ""
          echo "To deploy PostgreSQL with the recommended region and SKU:"
          echo "  1. Review the recommendations in the logs above"
          echo "  2. Run: az deployment group create --resource-group <rg-name> --template-file infra/postgres.bicep"
          echo "  3. Specify parameters: location, skuName, skuTier, administratorPassword"
          echo ""
          echo "For more details, see: infra/DEPLOYMENT_GUIDE.md"
          echo "=========================================="
